# GetX 컨트롤러 스코프 관리

## 컨트롤러 스코프란?

컨트롤러 스코프는 GetX 컨트롤러가 어디서 등록되고 어디서 접근 가능한지를 결정하는 범위입니다.

## GetX 컨트롤러 등록 방법

### 1. Get.put() - 컨트롤러 등록 및 반환

```dart
// 컨트롤러를 등록하고 해당 인스턴스를 반환
final controller = Get.put(CounterController());
```

**특징:**

- 컨트롤러를 생성하고 등록한 후, 해당 인스턴스를 반환
- 항상 성공 (새로 생성하므로)
- 등록된 곳에서만 접근 가능 (기본적으로 위젯 스코프)

### 2. Get.find() - 등록된 컨트롤러 찾기

```dart
// 이미 등록된 컨트롤러를 찾아서 반환
final controller = Get.find<CounterController>();
```

**특징:**

- 등록된 컨트롤러를 찾아서 반환
- 등록되지 않았으면 에러 발생
- 등록된 곳 어디서든 접근 가능

## 스코프별 등록 위치와 접근 범위

### 📍 main.dart에서 전역 등록

```dart
// main.dart
void main() {
  // 전역 등록 - 앱 전체에서 접근 가능
  Get.put(UserController(), permanent: true);
  Get.put(SettingsController(), permanent: true);
  Get.put(CartController(), permanent: true);

  runApp(MyApp());
}
```

**결과:** 모든 페이지, 모든 위젯에서 `Get.find<UserController>()`로 접근 가능

#### 예제: 전역 상태 관리

```dart
// lib/controllers/user_controller.dart
class UserController extends GetxController {
  final name = '홍길동'.obs;
  final age = 25.obs;
  final isLoggedIn = false.obs;

  void updateProfile(String newName, int newAge) {
    name.value = newName;
    age.value = newAge;
  }

  void login() {
    isLoggedIn.value = true;
  }

  void logout() {
    isLoggedIn.value = false;
  }
}

// main.dart
void main() {
  Get.put(UserController(), permanent: true);
  runApp(MyApp());
}

// 모든 곳에서 접근 가능
class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final userController = Get.find<UserController>(); // ✅ 접근 가능
    return Text('${userController.name.value}');
  }
}

class SettingsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final userController = Get.find<UserController>(); // ✅ 접근 가능
    return Text('${userController.age.value}');
  }
}

class AnyWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final userController = Get.find<UserController>(); // ✅ 접근 가능
    return Text('${userController.isLoggedIn.value}');
  }
}
```

### 📍 특정 페이지에서 등록

```dart
class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    // HomePage 스코프에서만 사용 가능
    final controller = Get.put(HomeController());

    return Scaffold(
      body: Column(
        children: [
          ProfileWidget(), // ✅ 같은 컨트롤러 공유
          ContentsWidget(), // ✅ 같은 컨트롤러 공유
        ],
      ),
    );
  }
}
```

**결과:** HomePage와 그 하위 위젯들에서만 접근 가능

#### 예제: 페이지별 상태 관리

```dart
// lib/controllers/home_controller.dart
class HomeController extends GetxController {
  final featuredItems = <String>[].obs;
  final currentTab = 0.obs;

  @override
  void onInit() {
    super.onInit();
    loadFeaturedItems();
  }

  void loadFeaturedItems() {
    featuredItems.value = ['아이템 1', '아이템 2', '아이템 3'];
  }

  void changeTab(int index) {
    currentTab.value = index;
  }
}

// HomePage
class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final homeController = Get.put(HomeController()); // HomePage 스코프

    return Scaffold(
      body: Column(
        children: [
          ProfileWidget(), // ✅ 같은 컨트롤러 공유
          ContentsWidget(), // ✅ 같은 컨트롤러 공유
        ],
      ),
    );
  }
}

// ProfileWidget
class ProfileWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final homeController = Get.find<HomeController>(); // ✅ 접근 가능
    return Obx(() => Text('${homeController.featuredItems.value}'));
  }
}

// SettingsPage (다른 페이지)
class SettingsPage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    // ❌ 에러: HomeController에 접근 불가
    // final homeController = Get.find<HomeController>();
    return Text('다른 페이지');
  }
}
```

### 📍 특정 위젯에서 등록

```dart
class ProfileWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    // ProfileWidget 스코프에서만 사용 가능
    final controller = Get.put(ProfileController());

    return Container(
      child: Column(
        children: [
          Text('${controller.name.value}'),
          ProfileImageWidget(), // ✅ 같은 컨트롤러 공유
        ],
      ),
    );
  }
}
```

**결과:** ProfileWidget 내부에서만 접근 가능

#### 예제: 위젯별 독립 상태

```dart
// lib/controllers/profile_controller.dart
class ProfileController extends GetxController {
  final name = '홍길동'.obs;
  final imageUrl = 'https://example.com/avatar.jpg'.obs;
  final isEditing = false.obs;

  void toggleEdit() {
    isEditing.value = !isEditing.value;
  }

  void updateName(String newName) {
    name.value = newName;
  }
}

// ProfileWidget
class ProfileWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final profileController = Get.put(ProfileController()); // ProfileWidget 스코프

    return Container(
      child: Column(
        children: [
          Text('${profileController.name.value}'),
          ProfileImageWidget(), // ✅ 같은 컨트롤러 공유
        ],
      ),
    );
  }
}

// ProfileImageWidget
class ProfileImageWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final profileController = Get.find<ProfileController>(); // ✅ 접근 가능
    return Image.network(profileController.imageUrl.value);
  }
}

// ContentsWidget (다른 위젯)
class ContentsWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    // ❌ 에러: ProfileController에 접근 불가
    // final profileController = Get.find<ProfileController>();
    return Text('다른 위젯');
  }
}
```

## permanent 파라미터의 영향

### permanent: false (기본값)

```dart
// 위젯 dispose 시 자동 삭제
final controller = Get.put(CounterController()); // permanent: false와 동일
```

**특징:**

- 위젯이 dispose되면 컨트롤러도 함께 삭제
- 메모리 자동 관리
- setState와 비슷한 로컬 상태 관리

### permanent: true

```dart
// 앱 종료까지 유지
final controller = Get.put(CounterController(), permanent: true);
```

**특징:**

- 위젯이 dispose되어도 컨트롤러 유지
- 앱 실행 중 전역 상태 공유
- 수동 메모리 관리 필요

#### 예제: permanent 차이점 확인

```dart
// lib/controllers/test_controller.dart
class TestController extends GetxController {
  final count = 0.obs;
  final timestamp = DateTime.now().obs;

  void increment() {
    count.value++;
    timestamp.value = DateTime.now();
    print('카운트 증가: ${count.value} (${timestamp.value})');
  }

  @override
  void onInit() {
    super.onInit();
    print('🟢 TestController 초기화: ${DateTime.now()}');
  }

  @override
  void onClose() {
    super.onClose();
    print('🔴 TestController 종료: ${DateTime.now()}');
  }
}

// permanent: false 테스트
class TestPage1 extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final controller = Get.put(TestController()); // permanent: false

    return Scaffold(
      appBar: AppBar(title: Text('Test Page 1 (permanent: false)')),
      body: Column(
        children: [
          Obx(() => Text('카운트: ${controller.count.value}')),
          Obx(() => Text('타임스탬프: ${controller.timestamp.value}')),
          ElevatedButton(
            onPressed: controller.increment,
            child: Text('증가'),
          ),
          ElevatedButton(
            onPressed: () => Get.to(() => TestPage2()),
            child: Text('다른 페이지로 이동'),
          ),
        ],
      ),
    );
  }
}

// permanent: true 테스트
class TestPage2 extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final controller = Get.put(TestController(), permanent: true);

    return Scaffold(
      appBar: AppBar(title: Text('Test Page 2 (permanent: true)')),
      body: Column(
        children: [
          Obx(() => Text('카운트: ${controller.count.value}')),
          Obx(() => Text('타임스탬프: ${controller.timestamp.value}')),
          ElevatedButton(
            onPressed: controller.increment,
            child: Text('증가'),
          ),
          ElevatedButton(
            onPressed: () => Get.back(),
            child: Text('뒤로 가기'),
          ),
        ],
      ),
    );
  }
}
```

## 안전한 컨트롤러 접근 방법

### 1. 등록 여부 확인 후 접근

```dart
class SafeWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    if (Get.isRegistered<SomeController>()) {
      final controller = Get.find<SomeController>();
      return Text('${controller.data.value}');
    }
    return Text('컨트롤러가 등록되지 않았습니다');
  }
}
```

### 2. 자동 등록 (권장)

```dart
class SafeWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    // 등록되지 않았으면 자동으로 등록
    final controller = Get.put(SomeController());
    return Text('${controller.data.value}');
  }
}
```

### 3. try-catch 사용

```dart
class SafeWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    try {
      final controller = Get.find<SomeController>();
      return Text('${controller.data.value}');
    } catch (e) {
      return Text('컨트롤러를 찾을 수 없습니다');
    }
  }
}
```

## 권장 사용 패턴

### 전역 상태 (main.dart에서 등록)

```dart
// 사용자 정보, 설정, 장바구니 등
void main() {
  Get.put(UserController(), permanent: true);
  Get.put(SettingsController(), permanent: true);
  Get.put(CartController(), permanent: true);
  runApp(MyApp());
}

// 어디서든 접근
class AnyWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final userController = Get.find<UserController>();
    return Text('${userController.name.value}');
  }
}
```

### 페이지별 상태 (페이지에서 등록)

```dart
// 페이지별 독립적인 상태
class HomePage extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final controller = Get.put(HomeController());
    return Scaffold(body: ...);
  }
}
```

### 위젯별 상태 (위젯에서 등록)

```dart
// 위젯별 독립적인 상태
class ProfileWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final controller = Get.put(ProfileController());
    return Container(child: ...);
  }
}
```

## 스코프 비교표

| 등록 위치       | 접근 범위               | 사용 예시                   | 메모리 관리            |
| --------------- | ----------------------- | --------------------------- | ---------------------- |
| **main.dart**   | 앱 전체                 | 사용자 정보, 설정, 장바구니 | 수동 (permanent: true) |
| **특정 페이지** | 해당 페이지 + 하위 위젯 | 페이지별 상태               | 자동                   |
| **특정 위젯**   | 해당 위젯만             | 위젯별 독립 상태            | 자동                   |

## 주의사항

### 1. 메모리 누수 방지

```dart
// ❌ 위험: 큰 데이터를 permanent로 유지
class HeavyController extends GetxController {
  final largeData = List.generate(1000000, (i) => i).obs;
}

// ✅ 권장: 적절한 정리
class HeavyController extends GetxController {
  @override
  void onClose() {
    largeData.clear(); // 큰 데이터 정리
    super.onClose();
  }
}
```

### 2. 스코프 벗어나서 접근

```dart
// ❌ 에러 발생
class SomeWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final controller = Get.find<SomeController>(); // 에러!
    return Text('${controller.data.value}');
  }
}

// ✅ 안전한 접근
class SomeWidget extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    final controller = Get.put(SomeController()); // 자동 등록
    return Text('${controller.data.value}');
  }
}
```

## 다음 단계

- [07*고급*컨트롤러\_관리.md](07_고급_컨트롤러_관리.md) - 고급 컨트롤러 관리 기법
- [08*성능*최적화.md](08_성능_최적화.md) - GetX 성능 최적화
- [09*실전*패턴.md](09_실전_패턴.md) - 실전에서 사용하는 패턴들
